# H2OHiveUDF
### Predictive Intelligence using H2O inside Hive UDF

### Original Challenge 

Run RScript to build model, create UDF to test the generated Model and verify the predictions are matching.

Rscript generates predictions using 'Gradient Boosted Learning Model' against sample test data.

H2O Rscript also generates reusable POJO model that can be used by any JVM language for training and predictions.

Problem Statement : https://github.com/h2oai/coding-challenges/tree/master/deployment/hive_udf

### Steps followed to verify H2O-R prediction matches with USF-Pojo prediction

#### 1. Environment Setup
##### RStudio - R Script development
##### SpringSource Toolsuite (STS) - UDF maven project development
##### HDP in VM - Create Hive tables, Run Hive Query , copy Udf jars, training data in HDFS

#### 2. Generate the POJO Model by running -  script.R

Ref : https://github.com/h2oai/coding-challenges/blob/master/deployment/hive_udf/script.R

** ensure h2o properly installed ** install.packages("h2o",repos="http://cran.cnr.berkeley.edu‚Äù)

** updated the script to predict on 10 columns (instead of 500 columns) for the ease of testing 

#### 3. Examine the content of frames generated by H2O-R script

head -2 fr

"response","C1","C2","C3","C4","C5","C6","C7","C8","C9","C10"

"0",0,79.00524687669414,1,62.34107756773965,94.72604293120712,-3.1683586213359094,37.19742854068111,-46.56359552425913,-62.62769638188415,-61

#### 4. Look at the prediction data

head -2 pred

"predict", "p0", "p1"

"1", 0.48181779315157247, 0.5181822068484275

#### 5. Now we create a table in Hive to hold the training data set

Import H2O frame (test data) into the table using HDP-beeswax

https://github.com/kaniska/H2OHiveUDF/blob/master/scorePrediction/docs/adult_data_set.tiff

response            	string              	                    
c1                  	int                 	                    
c2                  	double              	                    
c3                  	double              	                    
c4                  	double              	                    
c5                  	double              	                    
c6                  	double              	                    
c7                  	double              	                    
c8                  	double              	                    
c9                  	double              	                    
c10                 	int   

#### 6. Create the UDF to generate predictions from H2O Pojo

i. create a maven project in Eclipse IDE

ii. copy the previously generated pojo model jar into the UDF project's localjars folder (ref #1)

iii. copy the generated pojo model source into UDF project's src folder (ref #1)

iv. write the UDF to return the prediction values

a. Ref : https://github.com/h2oai/h2o-world-2015-training/blob/master/tutorials/hive_udf_template/src/main/java/ai/h2o/hive/udf/ScoreDataUDF.java

b. write test case to verify H2O prediction and UDF predictions are matching.

** In the testcase, the expected values are derived from prediction record (derived in #4)

** Here we see the UDF-evaluted prediction is matching with expected values !

  ##### Assert.assertEquals(1.0, ((Double)doublVals[0]).doubleValue());  - PASS
  
  ##### Assert.assertEquals(0.4818177, doublVals[1],tolerance); - PASS
  
  ##### Assert.assertEquals(0.51818, doublVals[2],tolerance); - PASS

#### 7. Generate the UDF jar - ScoreData-1.110-SNAPSHOT.jar

#### 8. Write Query to fetch predictions from UDF

i. use Beewax UI to load the h20_genmodel and scoredata jars

ii. select score(c1, c2, c3, c4, c5, c6, c7, c8, c9, c10) as preds FROM score_table

iii. 4 map and 4 reduce tasks are spawned to utilize 4 cores.

https://github.com/kaniska/H2OHiveUDF/blob/master/scorePrediction/docs/hive_udf_query.tiff

###### preds
###### 1
###### 1
###### 1
###### 1
###### 1
###### 1
###### 1
###### 1
###### 1

### Issues

1. Only first column values displayed. I did some RnD , but couldn't manage enough to extract the individual column values from the multi-valued list/array returned by the UDF.  Actually I need to display preds[0] , preds[1] , preds[3] and save into another table / csv , but currently only pred[0] is displayed by default.
